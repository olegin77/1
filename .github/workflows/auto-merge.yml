name: "Auto-merge Codex âžœ main"

on:
  push:
    branches:
      - codex

jobs:
  merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config user.name "codex-bot"
          git config user.email "codex@github-actions.local"

      - name: Merge codex -> main
        run: |
          git fetch origin main
          git checkout main
          git merge --no-edit origin/codex || true
          git push origin main

      - name: Trigger DigitalOcean App redeploy
        if: success()
        env:
          DO_API_TOKEN: ${{ secrets.DO_API_TOKEN }}
          DO_APP_ID: ${{ secrets.DO_APP_ID }}
        run: |
          curl -X POST "https://api.digitalocean.com/v2/apps/${DO_APP_ID}/deployments" \
            -H "Authorization: Bearer ${DO_API_TOKEN}" \
            -H "Content-Type: application/json"

